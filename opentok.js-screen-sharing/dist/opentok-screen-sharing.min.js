(function(){var e,n,o;"object"==typeof module&&"object"==typeof module.exports?(e=require("underscore"),n=require("jquery"),o=require("opentok-solutions-logging")):(e=this._,n=this.$,o=this.OTKAnalytics);var t,i,r,s,a,c=['<div class="ots-video-control circle share-screen" id="startScreenSharing"></div>'].join("\n"),l=['<div class="hidden" id="screenShareView">','<div class="ots-feed-main-video">','<div class="ots-feed-holder" id="videoHolderScreenShare"></div>','<div class="ots-feed-mask"></div>','<img src="https://assets.tokbox.com/solutions/images/widget-video-mask.png"/>',"</div>",'<div class="ots-feed-call-controls" id="feedControlsFromScreen">','<button class="ots-icon-screen active hidden" id="endScreenShareBtn"></button>',"</div>","</div>"].join("\n"),d=['<div id="dialog-form-chrome" class="ots-ss-modal" style="display: none;">','<div class="ots-modal-body">','<div class="ots-modal-title with-icon">','<i class="ots-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Chrome extension to share your screen. Install Screensharing Extension. Once you have installed, please, click the share screen button again.</p>",'<button id="btn-install-plugin-chrome" class="ots-btn-install">Accept</button>','<button id="btn-cancel-plugin-chrome" class="ots-cancel-btn-install"></button>',"</div>","</div>",'<div id="dialog-form-ff" class="ots-ss-modal" style="display: none;">','<div class="ots-modal-body">','<div class="ots-modal-title with-icon">','<i class="ots-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Firefox extension to share your screen. Install Screensharing Extension. Once you have installed, refresh your browser and click the share screen button again.</p>",'<a href="#" id="btn-install-plugin-ff" class="ots-btn-install">Install extension</a>','<a href="#" id="btn-cancel-plugin-ff" class="ots-cancel-btn-install"></a>',"</div>","</div>"].join("\n"),h={clientVersion:"js-vsol-1.1.0",componentId:"screenSharingAccPack",name:"guidScreensharingAccPack",actionInitialize:"Init",actionStart:"Start",actionEnd:"End",enableAnnotations:"EnableAnnotations",disableAnnotations:"DisableAnnotations",enableAudioScreenSharing:"EnableAudioScreenSharing",disableAudioScreenSharing:"DisableAudioScreenSharing",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},u=function(){var e=window.location.href,n={clientVersion:h.clientVersion,source:e,componentId:h.componentId,name:h.name};a=new o(n);var t={sessionId:s.id,connectionId:s.connection.connectionId,partnerId:s.apiKey};a.addSessionInfo(t)},g=function(e,n){var o={action:e,variation:n};a.logEvent(o)},f={insertMode:"append",width:"100%",height:"100%",showControls:!1,style:{buttonDisplayMode:"off"},videoSource:"window"},p=function(e){n("body").append(d),n(t.controlsContainer).append(c),n(e).append(l)},v=function(e){n("#startScreenSharing")[e?"show":"hide"]()},S=function(e,n){r&&r.triggerEvent(e,n)},m=function(){var o=function(o){var i=n.Deferred(),r=function(){return o?o:"function"==typeof t.screenSharingContainer?document.querySelector(t.screenSharingContainer("publisher","screen")):t.screenSharingContainer},s=r(),a=t.localScreenProperties||t.localScreenProperties||f;return t.publisher=OT.initPublisher(s,a,function(n){n?(S("screenSharingError",n),i.reject(e.extend(e.omit(n,"messsage"),{message:"Error starting the screen sharing"}))):i.resolve()}),i.promise()},i=n.Deferred();return t.annotation&&t.externalWindow?(g(h.enableAnnotations,h.variationSuccess),r.setupExternalAnnotation().then(function(e){t.annotationWindow=e||null;var n=e.createContainerElements();o(n.publisher).then(function(){i.resolve(n.annotation)})})):o().then(function(){i.resolve()}),i.promise()},b=function(o){s.publish(t.publisher,function(s){if(s){var a=e.omit(s,"message");if(1500===s.code&&navigator.userAgent.indexOf("Firefox")!==-1)n("#dialog-form-ff").toggle();else{var c;c=1010===s.code?"Check your network connection":"Error sharing the screen",a.message=c,S("screenSharingError",a),g(h.actionStart,h.variationError)}}else t.annotation&&t.externalWindow&&(r.linkAnnotation(t.publisher,o,t.annotationWindow),g(h.actionInitialize,h.variationSuccess)),i=!0,S("startScreenSharing",t.publisher),g(h.actionStart,h.variationSuccess)})},x=function(){s.unpublish(t.publisher)},w=function(){var e=n.Deferred();return"http:"!==window.location.protocol||t.dev||(alert("Screensharing only works under 'https', please add 'https://' in front of your debugger url."),e.reject("https required")),OT.checkScreenSharingCapability(function(o){o.supported&&o.extensionRegistered?o.extensionInstalled?e.resolve():(n("#dialog-form-chrome").toggle(),e.reject("screensharing extension not installed")):"Firefox"===OT.$.browser()&&o.extensionInstalled?e.resolve():"Firefox"!==OT.$.browser()||o.extensionInstalled?(alert("This browser does not support screen sharing! Please use Chrome, Firefox or IE!"),e.reject("browser support not available")):(n("#dialog-form-ff").toggle(),e.reject("screensharing extension not installed"))}),e.promise()},y=function(){g(h.actionStart,h.variationAttempt),w(t.extensionID,t.extensionPathFF).then(m).then(b).fail(function(e){console.log("Error starting screensharing: ",e),g(h.actionStart,h.variationError)})},E=function(e){x(),i=!1,e&&v(!1),S("endScreenSharing",t.publisher),g(h.actionEnd,h.variationSuccess)},I=function(){if(r){var e=["startScreenSharing","endScreenSharing","screenSharingError"];r.registerEvents(e)}},k=function(){var o=e.throttle(function(){i?E():y()},750);n("#startScreenSharing").on("click",o),n("#btn-install-plugin-chrome").on("click",function(){chrome.webstore.install(["https://chrome.google.com/webstore/detail/",t.extensionID].join(""),function(e){console.log("success",e)},function(e){console.log("error",e)}),n("#dialog-form-chrome").toggle()}),n("#btn-cancel-plugin-chrome").on("click",function(){n("#dialog-form-chrome").toggle()}),n("#btn-install-plugin-ff").prop("href",t.extensionPathFF),n("#btn-install-plugin-ff").on("click",function(){n("#dialog-form-ff").toggle()}),n("#btn-cancel-plugin-ff").on("click",function(){n("#dialog-form-ff").toggle()}),r&&(r.registerEventListener("startCall",function(){v(!0)}),r.registerEventListener("endCall",function(){i?E(!0):v(!1)}),r.registerEventListener("annotationWindowClosed",function(){E()}))},A=function(e){if("Chrome"===OT.$.browser()){if(!e||!e.length)throw new Error("Error starting the screensharing. Chrome extensionID required");n("<link/>",{rel:"chrome-webstore-item",href:["https://chrome.google.com/webstore/detail/",e].join("")}).appendTo("head"),OT.registerScreenSharingExtension("chrome",e,2)}},C=function(n){if(!e.property("session",n))throw new Error("Screen Share Acc Pack requires an OpenTok session");s=e.property("session")(n),r=e.property("accPack")(n),A(e.property("extensionID")(n),e.property("extensionPathFF")(n))},P=function(n){t=this,C(n);var o=["annotation","externalWindow","extensionURL","extensionID","extensionPathFF","screenSharingContainer","screenSharingParent","controlsContainer","screenProperties","localScreenProperties","dev"];e.extend(t,e.defaults(e.pick(n,o),{screenSharingParent:"#videoContainer",screenSharingContainer:document.getElementById("videoHolderSharedScreen"),controlsContainer:"#feedControls"})),p(t.screensharingParent),I(),k(),u(),g(h.actionInitialize,h.variationSuccess)};P.prototype={constructor:P,extensionAvailable:w,start:y,end:E},"object"==typeof exports?module.exports=P:"function"==typeof define&&define.amd?define(function(){return P}):this.ScreenSharingAccPack=P}).call(this);